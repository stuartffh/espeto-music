# üöÄ PLANO DE MIGRA√á√ÉO PARA SAAS MULTI-TENANT

## üìã VIS√ÉO GERAL

Transformar o Espeto Music de sistema single-tenant para **SaaS multi-tenant**, permitindo:
- **1 Super Admin** gerenciar todos estabelecimentos
- **M√∫ltiplos Estabelecimentos** isolados
- **M√∫ltiplas TVs** por estabelecimento
- **Clientes** acessam via QR Code espec√≠fico do estabelecimento

---

## üèóÔ∏è ARQUITETURA

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              SUPER ADMIN (superadmin.espeto.com)         ‚îÇ
‚îÇ  - Cria estabelecimentos                                 ‚îÇ
‚îÇ  - Gerencia planos                                       ‚îÇ
‚îÇ  - Visualiza estat√≠sticas globais                        ‚îÇ
‚îÇ  - Configura limites por plano                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚ñº               ‚ñº               ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Estabelec. ‚îÇ  ‚îÇ  Estabelec. ‚îÇ  ‚îÇ  Estabelec. ‚îÇ
    ‚îÇ      1      ‚îÇ  ‚îÇ      2      ‚îÇ  ‚îÇ      N      ‚îÇ
    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
    ‚îÇ Admin Local ‚îÇ  ‚îÇ Admin Local ‚îÇ  ‚îÇ Admin Local ‚îÇ
    ‚îÇ Config      ‚îÇ  ‚îÇ Config      ‚îÇ  ‚îÇ Config      ‚îÇ
    ‚îÇ Tema        ‚îÇ  ‚îÇ Tema        ‚îÇ  ‚îÇ Tema        ‚îÇ
    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
    ‚îÇ TV 1, TV 2  ‚îÇ  ‚îÇ TV 1        ‚îÇ  ‚îÇ TV 1, 2, 3  ‚îÇ
    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
    ‚îÇ Clientes    ‚îÇ  ‚îÇ Clientes    ‚îÇ  ‚îÇ Clientes    ‚îÇ
    ‚îÇ (QR Code)   ‚îÇ  ‚îÇ (QR Code)   ‚îÇ  ‚îÇ (QR Code)   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üóÑÔ∏è MUDAN√áAS NO BANCO DE DADOS

### ‚úÖ Novos Models

#### 1. **SuperAdmin**
```prisma
model SuperAdmin {
  id       String @id @default(uuid())
  username String @unique
  password String
  nome     String
  email    String @unique
  ativo    Boolean @default(true)
}
```

#### 2. **Estabelecimento** (Tenant)
```prisma
model Estabelecimento {
  id                String @id @default(uuid())
  nome              String
  slug              String @unique // URL amig√°vel
  codigo            String @unique // C√≥digo de acesso r√°pido
  email             String?
  ativo             Boolean @default(true)
  plano             String @default("basico")
  limiteTVs         Int @default(2)
  limiteMusicasMes  Int @default(1000)
  adminNome         String
  adminEmail        String
}
```

#### 3. **TV** (Terminal)
```prisma
model TV {
  id                   String @id @default(uuid())
  estabelecimentoId    String
  nome                 String
  codigo               String @unique // Para autentica√ß√£o
  ativo                Boolean @default(true)
  online               Boolean @default(false)
  ultimaConexao        DateTime?
}
```

### üîÑ Models Modificados (adicionam `estabelecimentoId`)

Todos os models abaixo ganham FK para `Estabelecimento`:
- ‚úÖ `PedidoMusica`
- ‚úÖ `Pagamento`
- ‚úÖ `Configuracao`
- ‚úÖ `EstadoPlayer`
- ‚úÖ `GiftCard`
- ‚úÖ `Sugestao`
- ‚úÖ `HistoricoBusca`
- ‚úÖ `PalavraProibida`
- ‚úÖ `Tema`
- ‚úÖ `Carrinho`
- ‚úÖ `Admin` (vira admin do estabelecimento)

---

## üîê AUTENTICA√á√ÉO E AUTORIZA√á√ÉO

### 1. **Super Admin**
- Acessa painel em `/super-admin`
- Credenciais √∫nicas no sistema
- Pode criar/editar/desativar estabelecimentos
- Visualiza todas as m√©tricas

### 2. **Admin do Estabelecimento**
- Acessa painel em `/admin/:slug` ou `/admin/:codigo`
- Username √∫nico DENTRO do estabelecimento
- Gerencia apenas seu estabelecimento
- Configura√ß√µes, TVs, Gift Cards, Modera√ß√£o

### 3. **TV (Terminal)**
- Autentica via WebSocket com `codigo` √∫nico
- Recebe apenas dados do pr√≥prio estabelecimento
- Socket room: `estabelecimento:{id}`

### 4. **Cliente**
- Acessa via QR Code: `/:slug/cliente` ou `/:codigo/cliente`
- N√£o precisa login
- V√™ apenas fila do estabelecimento

---

## üì° ISOLAMENTO DE DADOS (Multi-tenancy)

### Middleware de Tenant Context

```javascript
// middleware/tenantContext.js
async function extractTenant(req, res, next) {
  // Op√ß√£o 1: Via subdom√≠nio (espeto1.espeto.com)
  const subdomain = req.hostname.split('.')[0];

  // Op√ß√£o 2: Via slug na URL (/espeto1/admin)
  const slug = req.params.slug || req.query.slug;

  // Op√ß√£o 3: Via c√≥digo (/ESP001/cliente)
  const codigo = req.params.codigo;

  // Op√ß√£o 4: Via TV code (WebSocket)
  const tvCode = req.headers['x-tv-code'];

  // Buscar estabelecimento
  const estabelecimento = await prisma.estabelecimento.findFirst({
    where: {
      OR: [
        { slug },
        { codigo },
        { tvs: { some: { codigo: tvCode } } }
      ],
      ativo: true
    }
  });

  if (!estabelecimento) {
    return res.status(404).json({ error: 'Estabelecimento n√£o encontrado' });
  }

  // Adicionar ao contexto
  req.estabelecimentoId = estabelecimento.id;
  req.estabelecimento = estabelecimento;

  next();
}
```

### Aplicar em Todas as Queries

```javascript
// Antes (single-tenant)
const pedidos = await prisma.pedidoMusica.findMany({
  where: { status: 'pago' }
});

// Depois (multi-tenant)
const pedidos = await prisma.pedidoMusica.findMany({
  where: {
    estabelecimentoId: req.estabelecimentoId,
    status: 'pago'
  }
});
```

---

## üîÑ WEBSOCKET COM MULTI-TENANCY

### Socket Rooms por Estabelecimento

```javascript
// socketHandler.js
socket.on('tv-authenticate', async (data) => {
  const { tvCode } = data;

  // Buscar TV e estabelecimento
  const tv = await prisma.tv.findUnique({
    where: { codigo: tvCode },
    include: { estabelecimento: true }
  });

  if (!tv || !tv.ativo) {
    return socket.emit('auth-failed');
  }

  // Marcar como online
  await prisma.tv.update({
    where: { id: tv.id },
    data: { online: true, ultimaConexao: new Date() }
  });

  // Entrar na room do estabelecimento
  socket.join(`estabelecimento:${tv.estabelecimentoId}`);

  socket.tvId = tv.id;
  socket.estabelecimentoId = tv.estabelecimentoId;

  socket.emit('auth-success', {
    estabelecimento: tv.estabelecimento.nome
  });
});

// Emitir eventos apenas para estabelecimento
function emitirParaEstabelecimento(estabelecimentoId, evento, dados) {
  io.to(`estabelecimento:${estabelecimentoId}`).emit(evento, dados);
}
```

---

## üé® FRONTEND - MUDAN√áAS

### 1. **Novo: Super Admin Dashboard**
- P√°gina: `/super-admin`
- Funcionalidades:
  - Listar estabelecimentos
  - Criar estabelecimento (form completo)
  - Editar estabelecimento
  - Ativar/Desativar
  - Ver estat√≠sticas globais
  - Gerenciar planos

### 2. **Admin Dashboard (modificado)**
- P√°gina: `/admin/:slug` ou `/admin/:codigo`
- Detecta estabelecimento pela URL
- Gerencia apenas seu estabelecimento
- Nova se√ß√£o: Gerenciar TVs
  - Listar TVs
  - Criar nova TV (gera c√≥digo)
  - Ver status online/offline
  - Ver √∫ltima conex√£o

### 3. **TV Player (modificado)**
- P√°gina: `/tv/:codigo`
- Autentica com c√≥digo da TV
- Recebe apenas eventos do estabelecimento
- WebSocket room: `estabelecimento:{id}`

### 4. **Cliente (modificado)**
- P√°gina: `/:slug/cliente` ou `/:codigo/cliente`
- Detecta estabelecimento pela URL
- QR Code gerado com URL espec√≠fica
- V√™ apenas fila do estabelecimento

---

## üìä SISTEMA DE PLANOS

### Planos Dispon√≠veis

| Plano | TVs | M√∫sicas/M√™s | Pre√ßo |
|-------|-----|-------------|-------|
| **B√°sico** | 2 | 1.000 | R$ 99/m√™s |
| **Pro** | 5 | 5.000 | R$ 249/m√™s |
| **Enterprise** | Ilimitado | Ilimitado | R$ 599/m√™s |

### Verifica√ß√£o de Limites

```javascript
// middleware/checkLimits.js
async function checkLimits(req, res, next) {
  const estabelecimento = await prisma.estabelecimento.findUnique({
    where: { id: req.estabelecimentoId }
  });

  // Verificar expira√ß√£o
  if (estabelecimento.dataExpiracao && estabelecimento.dataExpiracao < new Date()) {
    return res.status(403).json({ error: 'Plano expirado' });
  }

  // Verificar limite de m√∫sicas
  if (estabelecimento.totalMusicasMes >= estabelecimento.limiteMusicasMes) {
    return res.status(403).json({ error: 'Limite de m√∫sicas atingido' });
  }

  next();
}
```

---

## üîß MIGRA√á√ÉO PASSO A PASSO

### Fase 1: Prepara√ß√£o (Sem Breaking Changes)
1. ‚úÖ Criar `schema-saas.prisma` (j√° feito)
2. ‚úÖ Documentar plano completo (este arquivo)
3. ‚è≥ Criar scripts de migra√ß√£o
4. ‚è≥ Criar seed para dados iniciais

### Fase 2: Backend
1. ‚è≥ Aplicar novo schema
2. ‚è≥ Criar middleware de tenant context
3. ‚è≥ Atualizar todos controllers
4. ‚è≥ Atualizar socketHandler
5. ‚è≥ Criar rotas do super admin
6. ‚è≥ Criar sistema de limites

### Fase 3: Frontend
1. ‚è≥ Criar painel Super Admin
2. ‚è≥ Modificar Admin Dashboard
3. ‚è≥ Modificar TV Player (autentica√ß√£o)
4. ‚è≥ Modificar Cliente (detec√ß√£o estabelecimento)
5. ‚è≥ Atualizar rotas

### Fase 4: Testes
1. ‚è≥ Testar isolamento de dados
2. ‚è≥ Testar autentica√ß√£o m√∫ltipla
3. ‚è≥ Testar WebSocket por estabelecimento
4. ‚è≥ Testar limites de plano

### Fase 5: Deploy
1. ‚è≥ Migrar banco de dados
2. ‚è≥ Deploy backend
3. ‚è≥ Deploy frontend
4. ‚è≥ Criar primeiro estabelecimento

---

## üìù SCRIPT DE MIGRA√á√ÉO DE DADOS

```javascript
// migrate-to-saas.js
async function migrarParaSaaS() {
  // 1. Criar Super Admin
  const superAdmin = await prisma.superAdmin.create({
    data: {
      username: 'superadmin',
      password: await bcrypt.hash('super123', 10),
      nome: 'Super Administrador',
      email: 'admin@espeto.com',
      ativo: true
    }
  });

  // 2. Criar Estabelecimento Padr√£o (migrar dados existentes)
  const estabelecimento = await prisma.estabelecimento.create({
    data: {
      nome: 'Espeto Music Demo',
      slug: 'demo',
      codigo: 'DEMO001',
      email: 'demo@espeto.com',
      ativo: true,
      plano: 'pro',
      limiteTVs: 5,
      limiteMusicasMes: 5000,
      adminNome: 'Admin Demo',
      adminEmail: 'admin@demo.com'
    }
  });

  // 3. Migrar Admin existente
  const adminAntigo = await prisma.admin.findFirst();
  if (adminAntigo) {
    await prisma.admin.update({
      where: { id: adminAntigo.id },
      data: { estabelecimentoId: estabelecimento.id }
    });
  }

  // 4. Criar TV padr√£o
  const tv = await prisma.tv.create({
    data: {
      estabelecimentoId: estabelecimento.id,
      nome: 'TV Principal',
      codigo: crypto.randomUUID().substring(0, 8).toUpperCase(),
      ativo: true
    }
  });

  // 5. Migrar todos os dados existentes
  await prisma.pedidoMusica.updateMany({
    data: { estabelecimentoId: estabelecimento.id }
  });

  await prisma.pagamento.updateMany({
    data: { estabelecimentoId: estabelecimento.id }
  });

  // ... migrar todos os outros models

  console.log('‚úÖ Migra√ß√£o conclu√≠da!');
  console.log('Estabelecimento:', estabelecimento.slug);
  console.log('C√≥digo TV:', tv.codigo);
}
```

---

## üåê ESTRUTURA DE URLs

### Super Admin
- `https://superadmin.espeto.com/` ‚Üí Painel Super Admin
- `https://superadmin.espeto.com/estabelecimentos` ‚Üí Lista
- `https://superadmin.espeto.com/estabelecimentos/novo` ‚Üí Criar

### Estabelecimento (Admin)
- `https://espeto.com/admin/:slug` ‚Üí Painel Admin
- `https://espeto.com/admin/:slug/tvs` ‚Üí Gerenciar TVs
- `https://espeto.com/admin/:slug/configuracoes` ‚Üí Configura√ß√µes

### TV
- `https://espeto.com/tv/:codigo` ‚Üí Player da TV

### Cliente
- `https://espeto.com/:slug/cliente` ‚Üí Interface Cliente
- `https://espeto.com/:codigo/cliente` ‚Üí Acesso por c√≥digo

---

## ‚úÖ PR√ìXIMOS PASSOS

1. ‚úÖ **Revisar este plano** com o time
2. ‚è≥ **Aprovar mudan√ßas** no schema
3. ‚è≥ **Criar branch** `feature/saas-multi-tenant`
4. ‚è≥ **Implementar Fase 2** (Backend)
5. ‚è≥ **Implementar Fase 3** (Frontend)
6. ‚è≥ **Testar em ambiente de dev**
7. ‚è≥ **Deploy em produ√ß√£o**

---

## üìû CONSIDERA√á√ïES FINAIS

### Vantagens do Multi-Tenant
- ‚úÖ Escalabilidade
- ‚úÖ Isolamento de dados
- ‚úÖ Personaliza√ß√£o por estabelecimento
- ‚úÖ Gest√£o centralizada
- ‚úÖ Modelo de receita recorrente

### Desafios
- ‚ö†Ô∏è Complexidade aumentada
- ‚ö†Ô∏è Migra√ß√£o de dados existentes
- ‚ö†Ô∏è Testes mais complexos
- ‚ö†Ô∏è Necessidade de bom middleware

### Recomenda√ß√µes
- üîí Implementar testes de isolamento
- üìä Monitorar performance por tenant
- üîê Validar sempre `estabelecimentoId`
- üìù Documentar bem as queries
- üß™ Criar fixtures de teste

---

**Vers√£o:** 1.0
**Data:** 2025-01-17
**Autor:** Claude Code + Equipe Espeto Music
