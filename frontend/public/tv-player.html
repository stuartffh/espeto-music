<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Espeto Music TV Player</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    /* ========== PLAYER CONTAINER ========== */
    #player-container {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
    }

    #youtube-player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* ========== OSD CONTROLS ========== */
    #osd {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
      padding: 20px;
      opacity: 0;
      transform: translateY(100%);
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10;
      pointer-events: none;
    }

    @media (prefers-reduced-motion: reduce) {
      #osd {
        transition: opacity 0.1s;
      }
    }

    #osd.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    #osd * {
      pointer-events: auto;
    }

    /* ========== PROGRESS BAR ========== */
    .progress {
      margin-bottom: 15px;
    }

    .bar {
      position: relative;
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
      cursor: pointer;
      transition: height 0.2s ease;
    }

    .bar:hover,
    .bar:focus-visible {
      height: 10px;
    }

    .bar:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 4px;
    }

    .fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, #e50914, #b20710);
      border-radius: 3px;
      pointer-events: none;
    }

    .thumb {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
    }

    .bar:hover .thumb,
    .bar:focus-visible .thumb {
      opacity: 1;
    }

    .time-tooltip {
      position: absolute;
      bottom: 100%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      white-space: nowrap;
    }

    .bar:hover .time-tooltip {
      opacity: 1;
    }

    /* ========== CONTROL BUTTONS ROW ========== */
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .left, .right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s ease;
      min-width: 40px;
      min-height: 40px;
    }

    button:hover {
      background: rgba(255,255,255,0.2);
    }

    button:active {
      background: rgba(255,255,255,0.3);
    }

    button:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }

    .round {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .time-display {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #fff;
      white-space: nowrap;
    }

    /* ========== VOLUME CONTROLS ========== */
    #vol {
      width: 100px;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }

    #vol::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
    }

    #vol::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    #vol:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 4px;
    }

    /* ========== LOADING SPINNER ========== */
    .spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
      z-index: 100;
    }

    .spinner.visible {
      display: block;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* ========== ERROR MESSAGE ========== */
    .error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(229, 9, 20, 0.95);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      font-size: 16px;
      max-width: 80%;
      text-align: center;
      display: none;
      z-index: 100;
    }

    .error.visible {
      display: block;
    }

    /* ========== MUSIC INFO OVERLAY ========== */
    #music-info {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      padding: 20px 30px;
      border-radius: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 200;
      border: 1px solid rgba(255,255,255,0.1);
    }

    #music-info.visible {
      opacity: 1;
    }

    #music-info .t {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #fff;
    }

    #music-info .c {
      font-size: 18px;
      color: #aaa;
    }

    /* ========== QUEUE OVERLAY ========== */
    #queue {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 200;
      max-width: 350px;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
    }

    #queue.visible {
      opacity: 1;
    }

    .q-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      color: #fff;
    }

    .q-item {
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid #e50914;
    }

    .q-item-title {
      font-size: 14px;
      color: #fff;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .q-item-client {
      font-size: 12px;
      color: #999;
    }

    .q-empty {
      color: #666;
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      #osd {
        padding: 15px;
      }

      .row {
        flex-direction: column;
        gap: 10px;
      }

      .left, .right {
        width: 100%;
        justify-content: center;
      }

      #vol {
        width: 150px;
      }

      #music-info, #queue {
        top: 10px;
        left: 10px;
        right: 10px;
        max-width: none;
      }

      #queue {
        top: auto;
        bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div id="player-container">
    <div id="youtube-player" aria-label="YouTube player"></div>

    <div id="osd" aria-hidden="false">
      <div class="progress">
        <div id="bar" class="bar" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0" aria-label="Barra de progresso">
          <div id="fill" class="fill"></div>
          <div id="thumb" class="thumb"></div>
          <div id="tt" class="time-tooltip" role="status">00:00</div>
        </div>
      </div>
      <div class="row">
        <div class="left">
          <button id="btn-play" class="round" aria-label="Reproduzir/Pausar">‚ñ∂</button>
          <button id="btn-rew" class="round" aria-label="Voltar 10 segundos">‚è™</button>
          <button id="btn-fwd" class="round" aria-label="Avan√ßar 10 segundos">‚è©</button>
          <div id="clock" class="time-display" aria-live="polite">00:00 / 00:00</div>
        </div>
        <div class="right">
          <button id="btn-vol" aria-label="Alternar mudo">üîä</button>
          <input id="vol" type="range" min="0" max="100" value="100" aria-label="Volume" />
          <button id="btn-full" aria-label="Tela cheia">‚õ∂</button>
        </div>
      </div>
    </div>

    <div id="loading" class="spinner" aria-hidden="true"></div>
    <div id="error" class="error" role="alert"></div>

    <aside id="music-info" aria-live="polite">
      <div id="m-title" class="t">-</div>
      <div id="m-client" class="c">-</div>
    </aside>
    <aside id="queue">
      <div class="q-title">üìã Pr√≥ximas M√∫sicas</div>
      <div id="q-list"></div>
    </aside>
  </div>

  <script type="module">
    // ========== UTILITIES ==========
    function fmt(sec) {
      if (!sec || isNaN(sec)) return '00:00';
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);
      if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      return `${m}:${String(s).padStart(2,'0')}`;
    }

    function clamp(val, min, max) {
      return Math.max(min, Math.min(max, val));
    }

    // ========== STATE ==========
    const state = {
      player: null,
      parentOrigin: null,
      updateLoop: null,
      osdTimer: null,
      dragging: false,
      currentMusicData: null,
      currentQueue: [],
      preloadNotified: false // Flag para evitar m√∫ltiplos avisos de pr√©-carregamento
    };

    // ========== DOM ELEMENTS ==========
    const els = {
      container: document.getElementById('player-container'),
      osd: document.getElementById('osd'),
      bar: document.getElementById('bar'),
      fill: document.getElementById('fill'),
      thumb: document.getElementById('thumb'),
      tooltip: document.getElementById('tt'),
      clock: document.getElementById('clock'),
      btnPlay: document.getElementById('btn-play'),
      btnRew: document.getElementById('btn-rew'),
      btnFwd: document.getElementById('btn-fwd'),
      btnVol: document.getElementById('btn-vol'),
      volSlider: document.getElementById('vol'),
      btnFull: document.getElementById('btn-full'),
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      musicInfo: document.getElementById('music-info'),
      mTitle: document.getElementById('m-title'),
      mClient: document.getElementById('m-client'),
      queue: document.getElementById('queue'),
      qList: document.getElementById('q-list')
    };

    // ========== YOUTUBE API LOADER ==========
    function loadYouTubeAPI() {
      return new Promise(resolve => {
        if (window.YT && window.YT.Player) {
          resolve();
          return;
        }
        window.onYouTubeIframeAPIReady = resolve;
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(tag);
      });
    }

    // ========== PLAYER CREATION ==========
    async function createPlayer(videoId) {
      await loadYouTubeAPI();

      return new Promise((resolve, reject) => {
        state.player = new YT.Player('youtube-player', {
          videoId,
          playerVars: {
            controls: 0,
            autoplay: 1,
            mute: 0, // IMPORTANTE: N√ÉO iniciar mutado
            rel: 0,
            modestbranding: 1,
            playsinline: 1,
            fs: 1,
            enablejsapi: 1,
            origin: window.location.origin,
            iv_load_policy: 3 // Desabilitar anota√ß√µes
          },
          events: {
            onReady: async (event) => {
              console.log('‚úÖ Player pronto');
              hideError();
              hideLoading();

              // GARANTIR √ÅUDIO: M√∫ltiplas tentativas de unmute + play
              let audioSuccess = false;
              for (let i = 0; i < 5; i++) {
                try {
                  // For√ßar unmute
                  event.target.unMute();
                  event.target.setVolume(80); // Volume inicial 80%

                  // Aguardar um pouco
                  await new Promise(r => setTimeout(r, 300));

                  // Verificar se est√° realmente unmuted
                  const isMuted = event.target.isMuted();
                  console.log(`üîä Tentativa ${i + 1}: isMuted = ${isMuted}`);

                  // Tocar v√≠deo
                  await event.target.playVideo();

                  // Aguardar iniciar
                  await new Promise(r => setTimeout(r, 500));

                  // Verificar se est√° tocando COM √°udio
                  const playerState = event.target.getPlayerState();
                  const volume = event.target.getVolume();

                  if (playerState === 1 && !event.target.isMuted() && volume > 0) {
                    console.log(`‚úÖ SUCESSO: Tocando com √°udio! (volume: ${volume}%)`);
                    audioSuccess = true;
                    break;
                  }
                } catch (e) {
                  console.warn(`‚ö†Ô∏è Tentativa ${i + 1} falhou:`, e);
                }
              }

              if (!audioSuccess) {
                console.warn('‚ö†Ô∏è AVISO: Player iniciou mas √°udio pode n√£o estar funcionando');
              }

              startUpdateLoop();
              sendMessage('video-started', { youtubeId: videoId, musica: state.currentMusicData });
              resolve(event.target);
            },
            onStateChange: handleStateChange,
            onError: handleError
          }
        });
      });
    }

    // ========== STATE CHANGE HANDLER ==========
    function handleStateChange(event) {
      const states = { '-1': 'unstarted', '0': 'ended', '1': 'playing', '2': 'paused', '3': 'buffering', '5': 'cued' };
      console.log(`üé¨ State: ${states[event.data] || 'unknown'}`);

      if (event.data === YT.PlayerState.ENDED) {
        stopUpdateLoop();
        sendMessage('video-ended', { youtubeId: state.player.getVideoData().video_id, musica: state.currentMusicData });
      }

      if (event.data === YT.PlayerState.PLAYING) {
        startUpdateLoop();
        updatePlayButton();
      }

      if (event.data === YT.PlayerState.PAUSED) {
        updatePlayButton();
      }
    }

    // ========== ERROR HANDLER ==========
    function handleError(event) {
      const errors = {
        2: 'Par√¢metro inv√°lido',
        5: 'Erro de reprodu√ß√£o HTML5',
        100: 'V√≠deo n√£o encontrado ou privado',
        101: 'V√≠deo n√£o permite reprodu√ß√£o em embed',
        150: 'V√≠deo n√£o permite reprodu√ß√£o em embed'
      };
      const msg = errors[event.data] || 'Erro desconhecido';
      console.error(`‚ùå Erro: ${msg} (${event.data})`);
      showError(msg);
      sendMessage('video-error', { errorCode: event.data, error: msg });
    }

    // ========== UPDATE LOOP ==========
    function startUpdateLoop() {
      stopUpdateLoop();
      state.updateLoop = setInterval(() => {
        if (!state.player || !state.player.getCurrentTime) return;
        updateProgressUI();
        sendTimeUpdate();
      }, 500);
    }

    function stopUpdateLoop() {
      if (state.updateLoop) {
        clearInterval(state.updateLoop);
        state.updateLoop = null;
      }
    }

    function updateProgressUI() {
      const cur = state.player.getCurrentTime() || 0;
      const dur = state.player.getDuration() || 0;

      if (dur > 0) {
        const pct = (cur / dur) * 100;
        els.fill.style.width = pct + '%';
        els.thumb.style.left = pct + '%';
        els.bar.setAttribute('aria-valuenow', Math.round(pct));

        // PR√â-CARREGAMENTO: Avisar quando estiver pr√≥ximo do fim (√∫ltimos 10 segundos)
        const timeRemaining = dur - cur;
        if (timeRemaining <= 10 && timeRemaining > 9.5 && !state.preloadNotified) {
          console.log('‚è∞ M√∫sica pr√≥xima do fim - avisar para pr√©-carregar pr√≥xima');
          sendMessage('video-near-end', {
            youtubeId: state.player.getVideoData().video_id,
            timeRemaining,
            queue: state.currentQueue
          });
          state.preloadNotified = true;
        }

        // Reset da flag quando longe do fim
        if (timeRemaining > 15) {
          state.preloadNotified = false;
        }
      }

      els.clock.textContent = `${fmt(cur)} / ${fmt(dur)}`;
    }

    function sendTimeUpdate() {
      if (!state.player) return;
      const time = state.player.getCurrentTime() || 0;
      const duration = state.player.getDuration() || 0;
      sendMessage('player-time-update', { time, duration });
    }

    // ========== CONTROLS ==========
    function togglePlay() {
      if (!state.player) return;
      const playerState = state.player.getPlayerState();
      if (playerState === YT.PlayerState.PLAYING) {
        state.player.pauseVideo();
      } else {
        state.player.playVideo();
      }
      updatePlayButton();
    }

    function updatePlayButton() {
      if (!state.player) return;
      const isPlaying = state.player.getPlayerState() === YT.PlayerState.PLAYING;
      els.btnPlay.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
      els.btnPlay.setAttribute('aria-label', isPlaying ? 'Pausar' : 'Reproduzir');
    }

    function seekRelative(delta) {
      if (!state.player) return;
      const cur = state.player.getCurrentTime() || 0;
      const dur = state.player.getDuration() || 0;
      const newTime = clamp(cur + delta, 0, dur);
      state.player.seekTo(newTime, true);
      updateProgressUI();
    }

    function seekFromEvent(e) {
      if (!state.player) return;
      const rect = els.bar.getBoundingClientRect();
      const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
      const pct = clamp(x / rect.width, 0, 1);
      const dur = state.player.getDuration() || 0;
      state.player.seekTo(pct * dur, true);
      updateProgressUI();
    }

    function updateTooltip(e) {
      const rect = els.bar.getBoundingClientRect();
      const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
      const pct = clamp(x / rect.width, 0, 1);
      const dur = state.player?.getDuration() || 0;
      els.tooltip.textContent = fmt(pct * dur);
      els.tooltip.style.left = (pct * 100) + '%';
    }

    function toggleMute() {
      if (!state.player) return;
      if (state.player.isMuted()) {
        state.player.unMute();
      } else {
        state.player.mute();
      }
      syncVolUI();
    }

    function setVolume(val) {
      if (!state.player) return;
      const vol = clamp(val, 0, 100);
      state.player.setVolume(vol);
      if (vol === 0) {
        state.player.mute();
      } else if (state.player.isMuted()) {
        state.player.unMute();
      }
      syncVolUI();
    }

    function syncVolUI() {
      if (!state.player) return;
      const vol = state.player.getVolume();
      const muted = state.player.isMuted();

      els.volSlider.value = vol;

      if (muted || vol === 0) {
        els.btnVol.textContent = 'üîá';
      } else if (vol < 50) {
        els.btnVol.textContent = 'üîâ';
      } else {
        els.btnVol.textContent = 'üîä';
      }
    }

    function toggleFullscreen() {
      const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);

      if (isFullscreen) {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
        else if (document.msExitFullscreen) document.msExitFullscreen();
      } else {
        const elem = els.container;
        if (elem.requestFullscreen) elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
        else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
      }
    }

    function handleFullscreenChange() {
      const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);

      // Notificar o Panel.jsx sobre mudan√ßa de fullscreen
      window.parent.postMessage({
        type: 'fullscreen-changed',
        isFullscreen: isFullscreen
      }, '*');

      console.log('üì∫ [TV-PLAYER] Fullscreen mudou:', isFullscreen);

      // N√ÉO mostrar music-info e queue em fullscreen
      // Isso agora √© controlado pelo FullscreenOverlay.jsx no Panel.jsx
      els.musicInfo.classList.remove('visible');
      els.queue.classList.remove('visible');

      showOsd();
    }

    // ========== OSD AUTO-HIDE ==========
    function showOsd() {
      els.osd.classList.add('visible');
      clearTimeout(state.osdTimer);

      const playerState = state.player?.getPlayerState();
      if (playerState === YT.PlayerState.PLAYING && !state.dragging) {
        state.osdTimer = setTimeout(() => {
          els.osd.classList.remove('visible');
        }, 2500);
      }
    }

    // ========== LOADING & ERROR ==========
    function showLoading() {
      els.loading.classList.add('visible');
      els.loading.setAttribute('aria-hidden', 'false');
    }

    function hideLoading() {
      els.loading.classList.remove('visible');
      els.loading.setAttribute('aria-hidden', 'true');
    }

    function showError(msg) {
      els.error.textContent = msg;
      els.error.classList.add('visible');
    }

    function hideError() {
      els.error.classList.remove('visible');
    }

    // ========== OVERLAYS ==========
    function setMusicInfo(data) {
      if (!data) return;
      state.currentMusicData = data;
      els.mTitle.textContent = data.titulo || '-';
      els.mClient.textContent = data.cliente ? `Pedido por: ${data.cliente}` : '-';
    }

    function setQueue(queue) {
      state.currentQueue = queue || [];
      els.qList.innerHTML = '';

      if (!queue || queue.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'q-empty';
        empty.textContent = 'Nenhuma m√∫sica na fila';
        els.qList.appendChild(empty);
        return;
      }

      const items = queue.slice(0, 5);
      items.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'q-item';

        const title = document.createElement('div');
        title.className = 'q-item-title';
        title.textContent = `${i + 1}. ${item.titulo || item.musicaTitulo || 'Sem t√≠tulo'}`;

        const client = document.createElement('div');
        client.className = 'q-item-client';
        client.textContent = item.cliente || item.nomeCliente || 'An√¥nimo';

        div.appendChild(title);
        div.appendChild(client);
        els.qList.appendChild(div);
      });

      if (queue.length > 5) {
        const more = document.createElement('div');
        more.className = 'q-item-client';
        more.style.textAlign = 'center';
        more.style.marginTop = '10px';
        more.textContent = `+${queue.length - 5} m√∫sica(s) na fila`;
        els.qList.appendChild(more);
      }
    }

    // ========== POST MESSAGE ==========
    function sendMessage(type, data = {}) {
      if (!state.parentOrigin) return;
      window.parent.postMessage({ type, ...data }, state.parentOrigin);
    }

    function handleMessage(event) {
      // Detect parent origin on first valid message
      if (!state.parentOrigin && event.origin && event.data?.type) {
        state.parentOrigin = event.origin;
        console.log('üîó Parent origin detected:', state.parentOrigin);
      }

      // Validate origin (in production, check against whitelist)
      if (state.parentOrigin && event.origin !== state.parentOrigin) {
        console.warn('‚ö†Ô∏è Message from untrusted origin:', event.origin);
        return;
      }

      const { type, youtubeId, musica, queue, volume, muted, parentOrigin } = event.data || {};

      switch (type) {
        case 'load-video':
          if (parentOrigin) state.parentOrigin = parentOrigin;
          if (musica) setMusicInfo(musica);
          if (youtubeId) {
            showLoading();
            state.preloadNotified = false; // Reset flag ao carregar novo v√≠deo

            // IMPORTANTE: Destruir player antigo antes de criar novo
            // Evita travamento ao trocar de m√∫sica
            if (state.player) {
              console.log('üîÑ Destruindo player antigo antes de carregar nova m√∫sica...');
              try {
                stopUpdateLoop(); // Para o loop de atualiza√ß√£o
                state.player.destroy(); // Destroi o player do YouTube
                state.player = null;
              } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao destruir player antigo:', e);
              }
            }

            // Criar novo player com delay para garantir limpeza
            setTimeout(() => {
              createPlayer(youtubeId);
            }, 100);
          }
          break;
        case 'host-ready':
          sendMessage('player-ready');
          break;
        case 'play':
          if (state.player) state.player.playVideo();
          break;
        case 'pause':
          if (state.player) state.player.pauseVideo();
          break;
        case 'stop':
          if (state.player) {
            state.player.stopVideo();
            state.player.seekTo(0);
          }
          break;
        case 'set-volume':
          if (typeof volume === 'number') setVolume(volume * 100);
          break;
        case 'set-muted':
          if (typeof muted === 'boolean') {
            if (muted) state.player?.mute();
            else state.player?.unMute();
            syncVolUI();
          }
          break;
        case 'update-queue':
          setQueue(queue);
          break;
        case 'remote-control':
          handleRemoteControl(event.data);
          break;
      }
    }

    // ========== REMOTE CONTROL HANDLER ==========
    function handleRemoteControl(command) {
      if (!state.player) {
        sendCommandResponse(command.commandId, 'error', 'Player n√£o inicializado');
        return;
      }

      const { type, time, volume, muted, commandId } = command;

      try {
        switch (type) {
          case 'play':
            state.player.playVideo();
            break;
          case 'pause':
            state.player.pauseVideo();
            break;
          case 'stop':
            state.player.stopVideo();
            state.player.seekTo(0);
            break;
          case 'seek':
            if (typeof time === 'number') {
              const dur = state.player.getDuration() || 0;
              state.player.seekTo(clamp(time, 0, dur), true);
            }
            break;
          case 'set-volume':
            if (typeof volume === 'number') {
              setVolume(volume * 100);
            }
            break;
          case 'set-muted':
            if (typeof muted === 'boolean') {
              if (muted) state.player.mute();
              else state.player.unMute();
              syncVolUI();
            }
            break;
          case 'next':
            sendMessage('video-ended', { youtubeId: state.player.getVideoData().video_id });
            break;
        }

        // Enviar resposta com estado atual
        sendCommandResponse(commandId, 'success', getPlayerState());
      } catch (error) {
        console.error('Erro ao executar comando remoto:', error);
        sendCommandResponse(commandId, 'error', error.message);
      }
    }

    function getPlayerState() {
      if (!state.player) return null;

      try {
        const playerState = state.player.getPlayerState();
        const states = { '-1': 'unstarted', '0': 'ended', '1': 'playing', '2': 'paused', '3': 'buffering', '5': 'cued' };

        return {
          state: states[playerState] || 'unknown',
          currentTime: state.player.getCurrentTime() || 0,
          duration: state.player.getDuration() || 0,
          volume: state.player.getVolume() || 0,
          muted: state.player.isMuted() || false,
          videoId: state.player.getVideoData()?.video_id || null
        };
      } catch (error) {
        console.error('Erro ao obter estado do player:', error);
        return null;
      }
    }

    function sendCommandResponse(commandId, status, data) {
      sendMessage('player-command-response', {
        commandId,
        status,
        state: status === 'success' ? data : null,
        error: status === 'error' ? data : null
      });
    }

    // ========== EVENT LISTENERS ==========
    els.btnPlay.addEventListener('click', togglePlay);
    els.btnRew.addEventListener('click', () => seekRelative(-10));
    els.btnFwd.addEventListener('click', () => seekRelative(10));
    els.btnVol.addEventListener('click', toggleMute);
    els.volSlider.addEventListener('input', (e) => setVolume(e.target.value));
    els.btnFull.addEventListener('click', toggleFullscreen);

    // Progress bar
    els.bar.addEventListener('pointerdown', (e) => {
      state.dragging = true;
      els.bar.setPointerCapture(e.pointerId);
      seekFromEvent(e);
      showOsd();
    });

    els.bar.addEventListener('pointermove', (e) => {
      updateTooltip(e);
      if (state.dragging) seekFromEvent(e);
    });

    els.bar.addEventListener('pointerup', (e) => {
      state.dragging = false;
      els.bar.releasePointerCapture(e.pointerId);
    });

    els.bar.addEventListener('pointerleave', () => {
      if (!state.dragging) {
        els.tooltip.style.opacity = '0';
      }
    });

    // Keyboard
    document.addEventListener('keydown', (e) => {
      showOsd();
      switch (e.key) {
        case ' ':
        case 'Enter':
          e.preventDefault();
          togglePlay();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          seekRelative(-10);
          break;
        case 'ArrowRight':
          e.preventDefault();
          seekRelative(10);
          break;
        case 'ArrowUp':
          e.preventDefault();
          if (state.player) {
            const vol = state.player.getVolume();
            setVolume(clamp(vol + 5, 0, 100));
          }
          break;
        case 'ArrowDown':
          e.preventDefault();
          if (state.player) {
            const vol = state.player.getVolume();
            setVolume(clamp(vol - 5, 0, 100));
          }
          break;
        case 'f':
        case 'F':
          e.preventDefault();
          toggleFullscreen();
          break;
        case 'Escape':
          showOsd();
          break;
      }
    });

    // Mouse move
    document.addEventListener('mousemove', showOsd, { passive: true });

    // Fullscreen
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);

    // Post message
    window.addEventListener('message', handleMessage);

    // Cleanup
    window.addEventListener('beforeunload', () => {
      stopUpdateLoop();
      clearTimeout(state.osdTimer);
    });

    // ========== INIT ==========
    showOsd();

    // Check for video ID in query string
    const params = new URLSearchParams(window.location.search);
    const videoId = params.get('id');
    if (videoId) {
      showLoading();
      createPlayer(videoId);
    }
  </script>
</body>
</html>
